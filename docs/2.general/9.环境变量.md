## 开始新进程时



**PM2 将在启动**新进程时按此顺序注入环境：



- 首先，PM2 CLI 会使用它自己的环境（即命令行中的输入），所以通过shell设置的` current environment`会被注入。
- 然后 PM2 会注入您通过配置文件设置的环境，比如

```js
module.exports = {
  apps : [
      {
        name: "myapp",
        script: "./app.js",
        watch: true,
        env: {
          "NODE_ENV": "development",
        }
      }
  ]
}
```

在这里可以看到 PM2 会覆盖` current environment`，来添加`NODE_ENV=development`。

但是您也可以像这样定义不同的环境：

```js
module.exports = {
  apps : [
      {
        name: "myapp",
        script: "./app.js",
        watch: true,
        env: {
            "PORT": 3000,
            "NODE_ENV": "development"
        },
        env_production: {
            "PORT": 80,
            "NODE_ENV": "production",
        }
      }
  ]
}
```

这里，默认的环境定义在`env`中，但是你可以通过使用`pm2 start ecosystem.config.js --env production`这条命令，来决定使用`env_production`作为默认的环境。



您可以定义任意数量的环境，只需记住必须在命令行中，在`--env`选项之后，传递环境的名字（即`env_`之后的部分）。

比如



## 特殊的环境变量

### NODE_APP_INSTANCE (PM2 2.5 minimum)

`NODE_APP_INSTANCE`环境变量用于区分不同的进程，比如说你想只在一个进程中运行一个cronjob，你就可以检查一下`process.env.NODE_APP_INSTANCE === '0'`。两个进程从来不会有同一个值，即使在执行`pm2 restart`和`pm2 scale`命令之后仍然如此。

在使用 [node-config](https://github.com/Unitech/pm2/issues/2045) 时你可能会遇到问题，因为它也有`NODE_APP_INSTANCE`这个属性，所以你可以使用`instance_var` 选项对其进行重命名：

```
module.exports = {
  apps : [
      {
        name: "myapp",
        script: "./app.js",
        watch: true,
        instance_var: 'INSTANCE_ID',
        env: {
            "PORT": 3000,
            "NODE_ENV": "development"
        }
      }
  ]
}
```

在这个案例中，当使用`process.env.INSTANCE_ID`时，和之前使用`process.env.NODE_APP_INSTANCE`有相同的表现。



#### increment_var (PM2 2.5 minimum)

有一个选项，可以在每个实例启动时，让PM2增加环境变量的值，比如：

```js
module.exports = {
  apps : [
      {
        name: "myapp",
        script: "./app.js",
        instances: 2,
        exec_mode: "cluster",
        watch: true,
        increment_var : 'PORT',
        env: {
            "PORT": 3000,
            "NODE_ENV": "development"
        }
      }
  ]
}
```

在这个示例中，如果执行了`pm2 start ecosystem.config.js`：

- PM2会看到我想为每个实例的PORT变量增加
- 它会看到我已经设置了默认的值是3000
- 于是第一个实例将会设置`process.env.PORT = 3000`，接着第二个实例设为`process.env.PORT = 3001`

**注意** : 



In this example, if i run `pm2 start ecosystem.config.js` :

- PM2 will see that i want to increment the `PORT` variable for each instance
- It will see that i have defined the default to `3000`
- The first instance will have `process.env.PORT = 3000` and the second `process.env.PORT = 3001`

**NOTE** : It will increment also when scaling using `pm2 scale myapp 4`, both new instances will have `3002` and `3003` as `PORT` variable.



# 译者补充

## 通过配置文件设置环境变量



```javascript
module.exports = {
  apps : [{
    name   : "app",
    script : "./app.js",
    // 直接pm2启动程序即可，会直接将env内的属性注入环境变量中
    env: {
       NODE_ENV: "production",
       APP_NAME: "MyApp"
    },
    env_development: {
       NODE_ENV: "development"
    }
  }]
}
```

在代码中访问环境变量：

```
process.env.APP_NAME
```



要使用`evn_development`定义的环境变量，需要在启动配置文件时：

```bash
pm2 start app.config.js --env development
```



demo：

`process.env`是当前进程的全部环境变量：

```javascript
// app.js
console.log('环境变量', process.env)
```



打印出来的结果很多，其中就包括：

```javascript
name: 'app',
script: './app.js',
env: '[object Object]',
env_development: '[object Object]',
    
    
NODE_ENV: 'production', // 通过配置文件的env属性传递的
```



说明，我们配置文件的内容，会被放到`process.env`中。

```javascript
console.log('NODE_ENV', process.env.NODE_ENV)
console.log('配置文件中的name', process.env.name)
console.log('配置文件中的env', process.env.env)
console.log('env_development', process.env.env_development)

// 输出
NODE_ENV production
配置文件中的name app
配置文件中的env [object Object]
env_development [object Object]
```



通过配置文件设置：

```javascript
module.exports = {
  apps: [{
    name: "koa-log4js",
    script: "./src/app.js",
   
    // 环境参数，当前指定为生产环境
    env: {
      "NODE_ENV": "production",  
      "REMOTE_ADDR": ""
    },
    
    // 环境参数，当前指定为开发环境
    env_dev: {
      "NODE_ENV": "development",  
      "REMOTE_ADDR": ""
    },
    
    // 环境参数，当前指定为测试环境
    env_test: {             
      "NODE_ENV": "test",
      "REMOTE_ADDR": ""
    },
    
    env_uat: {
            "PORT": 3030,
            "NODE_ENV": "uat"
          },
  }]
}
```
